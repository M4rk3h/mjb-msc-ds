-- 0.1-DELETE ALL TABLES
DROP TABLE CENTRE;
DROP TABLE SALESMAN;
DROP TABLE CARSALE;
DROP TABLE CUSTOMER;

-- 0.2-CREATE THE TABLES & INSERT DATA
-- CENTRE
CREATE TABLE CENTRE(
	CENTRENO 		CHAR(4) NOT NULL,
    ADDRESS		    CHAR(50),
    CONTACTNO		VARCHAR(15), -- COULD BE NUMBER OR NUMERIC
	CONSTRAINT CENTRE_CENTRENO_PK PRIMARY KEY(CENTRENO)
);

-- CENTRE
INSERT INTO CENTRE (CENTRENO, ADDRESS, CONTACTNO) VALUES ('001', 'TREFF', '01443 875456');
INSERT INTO CENTRE (CENTRENO, ADDRESS, CONTACTNO) VALUES ('002', 'NEWPORT', '01495 789456');
INSERT INTO CENTRE (CENTRENO, ADDRESS, CONTACTNO) VALUES ('003', 'PONTYPRIDD', '01443 123546');

-- SALESMAN
CREATE TABLE SALESMAN(
	SALESMANNO 		CHAR(4) NOT NULL,
    SPNAME			CHAR(35),
	CONTACTNO		VARCHAR(15), --COULD BE NUMBER OR NUMERIC
	DOB				DATE,
	CENTRENO		CHAR(4),
	CONSTRAINT SALESMAN_SALESMANNO_PK PRIMARY KEY(SALESMANNO)
);

-- SALESMAN
-- CENTRE 1
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('001', 'MARK BABER', '07415467895', '31-MAY-92', '001');
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('003', 'HANNAH EVANS', '07412541263', '18-DEC-92', '001');
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('004', 'ISA LARA', '07497517987', '31-MAY-92', '001');
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('006', 'KEZIAH MELTON', '07700053700', '18-DEC-92', '001');
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('010', 'ELIZA ELLIOTT', '07663075294', '18-AUG-65', '001');

-- CENTRE 2
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('002', 'LLOYD JAMES', '08456321254', '28-MAR-92', '002');
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('005', 'YVETTE NAIRN', '07508307983', '28-MAR-92', '002');
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('007', 'LOGAN WILLIAMSON', '07533580223', '25-AUG-63', '002');
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('008', 'SARA THOMSON', '07669035741', ' 25-OCT-99', '002');
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('009', 'ELLIS MCDONALD', '07894572067','08-FEB-50', '002');

-- CENTRE 3
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('011', 'AUBREY GILL','07571065769','09-APR-77','003');
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('013', 'MYA BARRETT','07933920980','14-MAY-93','003');
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('012', 'SEAN MORGAN','07565335159','25-DEC-56','003');
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('014', 'SKYLER BYRNE','07663075294','30-JUL-77','003');
INSERT INTO SALESMAN (SALESMANNO, SPNAME, CONTACTNO, DOB, CENTRENO) VALUES ('015', 'ELOISE MURRAY','07552451436','14-MAY-87','003');

-- CUSTOMER
CREATE TABLE CUSTOMER(
	CUSTOMERNO 			CHAR(4) NOT NULL,
    CNAME				CHAR(35),
	CONTACTNO			VARCHAR(15), -- COULD BE NUMBER OR NUMERIC
	CADDRESS			VARCHAR(60),
	DOB					DATE,
	DRIVERSLICENCENO	VARCHAR(16),
	ONCREDIT			CHAR(3),
	BADDEBTOR			CHAR(3),
	CONSTRAINT CUSTOMER_CUSTOMERNO_PK PRIMARY KEY(CUSTOMERNO)
);
-- CUSTOMER
INSERT INTO CUSTOMER (CUSTOMERNO, CNAME, CONTACTNO, CADDRESS, DOB, DRIVERSLICENCENO, ONCREDIT, BADDEBTOR) VALUES ('001', 'DARNELL MCCALLUM', '07457491253', '13 BROADWAY, TORQUAY, TQ63 1AM', '16-DEC-92', 'QSW3BSRYY6UBMF3S', 'N', 'N');
INSERT INTO CUSTOMER (CUSTOMERNO, CNAME, CONTACTNO, CADDRESS, DOB, DRIVERSLICENCENO, ONCREDIT, BADDEBTOR) VALUES ('002', 'JAMES HETFIELD', '07456321458', '73 NEW ROAD, EAST CENTRAL LONDON, EC98 4HM', '05-JAN-59', 'FVGUEPVRHBWF69R8', 'Y', 'Y');
INSERT INTO CUSTOMER (CUSTOMERNO, CNAME, CONTACTNO, CADDRESS, DOB, DRIVERSLICENCENO, ONCREDIT, BADDEBTOR) VALUES ('003', 'ROSITA JONES', '07457897895', '78 STANLEY ROAD, WATFORD, WD77 8IA', '24-JAN-68', 'TDF9MPY2RGS2CKMV', 'Y', 'N');
INSERT INTO CUSTOMER (CUSTOMERNO, CNAME, CONTACTNO, CADDRESS, DOB, DRIVERSLICENCENO, ONCREDIT, BADDEBTOR) VALUES ('004', 'MAC POWELL', '07451234520', '87 THE DRIVE, READING, RG89 7EY', '20-FEB-88', 'GD55QSU3TH4MZD7F', 'N', 'Y');
INSERT INTO CUSTOMER (CUSTOMERNO, CNAME, CONTACTNO, CADDRESS, DOB, DRIVERSLICENCENO, ONCREDIT, BADDEBTOR) VALUES ('005', 'BETHANY MILLS', '07580879651', '1 CHURCH LANE, BATH, BA33 3MA', '18-FEB-69', 'GUH0IYWXFT2A8KTS', 'N', 'N');
INSERT INTO CUSTOMER (CUSTOMERNO, CNAME, CONTACTNO, CADDRESS, DOB, DRIVERSLICENCENO, ONCREDIT, BADDEBTOR) VALUES ('006', 'ZAC HART', '07831826626', '198 HIGHFIELD ROAD, REDHILL, RH98 3HF', '01-SEP-70', 'KJHA7WH5H8LXKM4Z', 'Y', 'Y');
INSERT INTO CUSTOMER (CUSTOMERNO, CNAME, CONTACTNO, CADDRESS, DOB, DRIVERSLICENCENO, ONCREDIT, BADDEBTOR) VALUES ('007', 'HARLEY CLARK', '07559418033', '78 GROVE ROAD, DUDLEY, DY25 4VR', '12-APR-75', '6ZVMYV7TH8DG9EQU', 'Y', 'N');
INSERT INTO CUSTOMER (CUSTOMERNO, CNAME, CONTACTNO, CADDRESS, DOB, DRIVERSLICENCENO, ONCREDIT, BADDEBTOR) VALUES ('008', 'LILLY HOLMES', '07822525536', '84 ALEXANDER ROAD, CREWE, CW96 2ZO', '02-APR-87', '91Y0FIHPPPE4GQKS', 'N', 'Y');
INSERT INTO CUSTOMER (CUSTOMERNO, CNAME, CONTACTNO, CADDRESS, DOB, DRIVERSLICENCENO, ONCREDIT, BADDEBTOR) VALUES ('009', 'DANE WEBB', '07574181372', '9405 KING STREET, HUDDERSFIELD, HD47 7EJ', '05-OCT-91', 'ZICQOMVYNZ1VIOW9', 'N', 'Y');
INSERT INTO CUSTOMER (CUSTOMERNO, CNAME, CONTACTNO, CADDRESS, DOB, DRIVERSLICENCENO, ONCREDIT, BADDEBTOR) VALUES ('010', 'ADAM RICHARDS', '07899845624', '1 MILL ROAD, NORTH LONDON, N82 3UJ', '09-FEB-97', 'QYOWZOISQ0OABORV', 'N', 'Y');

-- CARSALE
CREATE TABLE CARSALE(
	CARSALENO 		CHAR(4) NOT NULL,
	CUSTOMERNO		CHAR(4),
	SALESMANNO      CHAR(4),
	CARSALEDATE		DATE,
	CARPRICE		NUMBER(6), --NUMBER FOR ORACLE
    ISINVOICE		CHAR,
	MILESDRIVEN		NUMBER(3),
	CONSTRAINT CARSALE_CARSALENO_PK PRIMARY KEY(CARSALENO)
);

-- CARSALE
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('001', '010', '002', '06-JUN-19', 2132, 'Y', '168');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('002', '009', '002', '30-JUN-19', 1210, 'Y', '250');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('003', '008', '006', '13-AUG-19', 15424, 'Y', '120');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('004', '004', '005', '28-SEP-19', 1210, 'Y', '250');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('005', '002', '003', '01-NOV-19', 10101, 'N', '303');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('006', '005', '015', '25-NOV-19', 7495, 'Y', '957');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('007', '006', '014', '24-MAR-20', 3999, 'Y', '148');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('008', '008', '010', '03-APR-20', 12995, 'Y', '737');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('009', '006', '005', '08-MAY-20', 10350, 'Y', '655');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('010', '003', '007', '18-MAY-20', 9789, 'N', '285');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('011', '002', '009', '11-JUN-20', 12500, 'N', '802');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('012', '001', '009', '09-JUL-20', 11909, 'N', '981');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('013', '001', '009', '13-JUL-20', 5095, 'N', '382');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('014', '002', '009', '24-AUG-20', 10000, 'N', '940');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('015', '008', '015', '29-SEP-20', 9000, 'N', '183');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('016', '008', '008', '01-DEC-20', 1023, 'N', '25');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('017', '001', '001', '02-DEC-20', 7895, 'Y', '50');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('018', '008', '008', '06-DEC-20', 10235, 'Y', '150');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('019', '002', '001', '15-DEC-20', 15000, 'N', '95');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('020', '002', '002', '12-DEC-20', 10000, 'Y', '50');
INSERT INTO CARSALE (CARSALENO, CUSTOMERNO, SALESMANNO, CARSALEDATE, CARPRICE, ISINVOICE, MILESDRIVEN) VALUES ('021', '003', '003', '23-DEC-20', 6545, 'Y', '150');

-- ADD FOREIGN KEYS
ALTER TABLE SALESMAN ADD FOREIGN KEY (CENTRENO) REFERENCES CENTRE(CENTRENO);
ALTER TABLE CARSALE ADD FOREIGN KEY (SALESMANNO) REFERENCES SALESMAN(SALESMANNO);
ALTER TABLE CARSALE ADD FOREIGN KEY (CUSTOMERNO) REFERENCES CUSTOMER(CUSTOMERNO);

-- SQL QUESTIONS
--
-- 1-PRODUCE A LIST OF CUSTOMERS IN CUSTOMER NUMBER ORDER. - (2 MARKS)

-- Create a View
Create View QuestionOne AS 
SELECT * FROM CUSTOMER;
-- Select from view 1
SELECT *
FROM QuestionOne
ORDER BY CUSTOMERNO ASC; -- ASC JUST TO BE SAFE

-- 2-PRODUCE A LIST OF SALES STAFF ORDERED BY CENTRE NUMBER THEN SALESPERSON NUMBER.
-- (THIS SHOULD BE ONE QUERY ONLY) - (3 MARKS)

-- Create a View
Create View QuestionTwo 
AS SELECT CENTRENO, SALESMANNO, SPNAME, CONTACTNO
FROM SALESMAN;
-- Select from view 2
SELECT * FROM QuestionTwo
ORDER BY CENTRENO, SALESMANNO;

-- 3-PRODUCE A LIST OF CAR SALES ORDERED BY SALESPERSON NUMBER THEN CAR PRICE.
-- (THIS SHOULD BE ONE QUERY ONLY) - (4 MARKS)

-- Create a View
Create View QuestionThree
AS SELECT CARSALENO, SALESMANNO, CARSALEDATE, CUSTOMERNO, CARPRICE
FROM CARSALE;
-- Select from view 3
SELECT *
FROM QuestionThree
ORDER BY SALESMANNO, CARPRICE;

-- 4-PRODUCE OUTPUT WHICH LISTS THE NUMBER OF CARS SOLD BY EACH SALESPERSON
-- FOR THE PAST 6 MONTHS (I.E. S1: 5 CARS , S2: 3 CARS ETC.) - (7 MARKS)

-- Couldn't figure out how to create a view for this one.
SELECT SALESMANNO AS SALESMAN, COUNT(CARPRICE) AS TOTALCARS
FROM CARSALE
WHERE CARSALEDATE >= ADD_MONTHS(SYSDATE, -6) -- Check last 6 months
GROUP BY SALESMANNO;

-- 5-(A)PRODUCE OUTPUT WHICH LISTS THE TOTAL COST OF THE CARS SOLD BY EACH SALESMAN IN THE PAST MONTH.
-- FOR EXAMPLE: S1 HAS SOLD CA12 JKN £8,500 CF59 JMK £10,100 - THEREFORE THE OUTPUT WOULD BE S1 18,600. (7 MARKS)

-- Couldn't figure out how to create a view for this one.
SELECT SALESMANNO, SUM(CARPRICE) AS TOTALCARSSOLDPRICE
FROM CARSALE
WHERE CARSALEDATE >= ADD_MONTHS(SYSDATE, -1) -- Check last 1 month
GROUP BY SALESMANNO;

-- 5-(B)FOR FOUR EXTRA MARKS,
-- ADD THE COMMISSION EARNED BY EACH SALESMAN TO THE ABOVE REPORT. (4 MARKS)

-- Create a view
SELECT SALESMANNO, SUM(CARPRICE) AS TOTALCARSSOLDPRICE,
CASE 
	WHEN ROUND(SUM(CARPRICE), 2) < 5000  THEN ROUND((SUM(CARPRICE) * 2) / 100, 2)
	WHEN ROUND(SUM(CARPRICE), 2) < 10000 THEN ROUND((SUM(CARPRICE) * 3) / 100, 2)
	WHEN ROUND(SUM(CARPRICE), 2) < 15000 THEN ROUND((SUM(CARPRICE) * 4 ) / 100, 2)
	WHEN ROUND(SUM(CARPRICE), 2) > 15000 THEN ROUND((SUM(CARPRICE) * 5 ) / 100, 2)
	--ELSE 'No Commission Worked Out' (ELSE DIDN'T WORK FOR SOME REASON)
END 
AS COMMISSION
FROM CARSALE
WHERE CARSALEDATE >= ADD_MONTHS(SYSDATE, -1) -- Check last 1 month
GROUP BY SALESMANNO;

-- 6-PRODUCE OUTPUT WHICH LISTS DETAILS OF THE MOST EXPENSIVE CAR SOLD IN THE PAST MONTH. (7 MARKS)

-- Create a view
Create view QuestionSix
AS SELECT *
FROM CARSALE
WHERE CARPRICE IN (
	SELECT MAX(CARPRICE)
	FROM CARSALE
	WHERE CARSALEDATE >= ADD_MONTHS(SYSDATE, -1) -- Check last 1 month
);
-- select from view six
SELECT *
FROM QuestionSix
ORDER BY CARPRICE;

-- 7-PRODUCE OUTPUT WHICH LIST ALL CAR SALES IN THE PAST MONTH.
-- INCLUDE SALESPERSON NUMBER, SALESPERSON NAME, CUSTOMER NUMBER, CUSTOMER NAME AND CUSTOMER ADDRESS IN YOUR OUTPUT.
-- ORDER BY SALESPERSON NUMBER. (9 MARKS)

-- Create a view
SELECT 
	CARSALE.CARSALENO as CarSale, 
    CARSALE.SALESMANNO as SalesmanNo, 
    SPNAME as SalesPerson, 
    CUSTOMER.CUSTOMERNO as CustomerNo,
    CUSTOMER.CNAME as Customer, 
    CUSTOMER.CADDRESS as CustomerAddress
FROM CARSALE
WHERE 
	CARSALEDATE >= ADD_MONTHS(SYSDATE, -1) -- Check last 1 month (Doesn't work in Microsoft SQLServer)
INNER JOIN 
	CUSTOMER ON 
    CARSALE.CUSTOMERNO = CUSTOMER.CUSTOMERNO
INNER JOIN 
	SALESMAN ON 
    CARSALE.SALESMANNO = SALESMAN.SALESMANNO
ORDER BY SALESMANNO ASC;

-- 8-PRODUCE A LIST OF CUSTOMERS THAT DO NOT CURRENTLY HAVE ANY CAR SALES IN THE CAR SALE TABLE.
-- (MAKE SURE THAT YOUR DATA CONTAINS CUSTOMERS WITHOUT ANY CURRENT CAR SALES)

-- Create a view
Create View QuestionEight
AS SELECT *
FROM CUSTOMER
WHERE CUSTOMERNO NOT IN (
	SELECT CUSTOMERNO
	FROM CARSALE
  	GROUP BY CUSTOMERNO
);
-- Select from view 8
SELECT *
FROM QuestionEight;